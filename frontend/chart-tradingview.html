<!-- TradingView Widget –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<div id="tradingview_widget" style="height: 500px; background: #1a1a1a;"></div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script type="text/javascript">
function initTradingViewWidget(symbol, trades, currentPosition) {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∞ (BTCUSDT -> BTCUSD –¥–ª—è TradingView)
    const tvSymbol = symbol.replace('USDT', 'USD');
    
    new TradingView.widget({
        "width": "100%",
        "height": 500,
        "symbol": `BINANCE:${tvSymbol}`,
        "interval": "5",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1", // 1 = Bars, 2 = Candles, 3 = Line, 8 = Hollow Candles
        "locale": "ru",
        "toolbar_bg": "#0f0f0f",
        "enable_publishing": false,
        "hide_side_toolbar": false,
        "allow_symbol_change": false,
        "save_image": false,
        "container_id": "tradingview_widget",
        "studies": [
            "RSI@tv-basicstudies",
            "MACD@tv-basicstudies"
        ],
        // –ú–µ—Ç–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        "drawings": generateDrawings(trades, currentPosition)
    });
}

function generateDrawings(trades, currentPosition) {
    const drawings = [];
    
    // –ú–µ—Ç–∫–∏ —Å–¥–µ–ª–æ–∫
    if (trades && trades.length > 0) {
        trades.forEach(trade => {
            drawings.push({
                type: 'ray',
                price: trade.entry_price,
                time: new Date(trade.entry_time).getTime() / 1000,
                color: '#4ade80',
                text: 'üü¢ –í—Ö–æ–¥'
            });
            
            drawings.push({
                type: 'ray',
                price: trade.exit_price,
                time: new Date(trade.exit_time).getTime() / 1000,
                color: '#ef4444',
                text: 'üî¥ –í—ã—Ö–æ–¥'
            });
        });
    }
    
    // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è
    if (currentPosition) {
        drawings.push({
            type: 'horizontal_line',
            price: currentPosition.entry_price,
            color: '#fbbf24',
            linewidth: 2,
            linestyle: 2, // dashed
            text: 'üìç –û—Ç–∫—Ä—ã—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è'
        });
    }
    
    return drawings;
}
</script>
